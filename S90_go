#!/usr/bin/zsh -f

# go environment
#
# DEFAULT VALUES
#
# GOPATH: $HOME/go
# GOROOT: $HOME/goroot

if [[ -z $GOPATH ]]
then
    typeset -x GOPATH="${HOME}/go"
fi

export PATH="${GOPATH}/bin:${PATH}"
ln -sfT "${GOPATH}/bin" "${HOME}/bin/golang"

function download_new_go {
    (
        source "${HOME}/.zsh.d/lib/_lib.sh"
        _confirm "Do you want to install latest Golang toolchain now?" || return 0

        echo -n "detecting cpu architecture ... "
        arch="$(case "$(uname -m)" in
x86_64)
  echo "amd64"
  ;;
aarch64)
  echo "arm64"
  ;;
*)
  echo "amd64"
  ;;
esac
)"
        echo $arch
        set -e
        echo -n "fetching go version ... "
        fn="$(curl -sSL https://go.dev/dl/ 2>/dev/null | grep -oE 'go[0-9]+\.[0-9]+\.[0-9]+\.linux-'"$arch"'\.tar\.gz'|head -n 1)"
        ver="$(echo "$fn" | cut -d o -f 2 | cut -d . -f 1-2)"
        echo "$ver"

        set +e
        rm -fr "${HOME}/golang"

        echo "download into ${HOME}/golang ..."
        echo

        set -e
        mkdir -p "${HOME}/golang"
        curl -sSL "https://go.dev/dl/${fn}" | tar zxvf - -C "${HOME}/golang" --strip-components 1
        ln -sfT "${HOME}/golang/bin/go" "${HOME}/bin/go"
    )
}

function go {
    whence -p go >/dev/null 2>&1 && {
        unset -f go
        go "$@"
        return $?
    }

    download_new_go && {
        unset -f go
        go "$@"
    }
}
